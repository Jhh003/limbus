<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排行榜管理后台 - Limbus Company</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/limbus-theme-v2.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--lc-border);
        }
        
        .admin-header h1 {
            color: var(--lc-gold);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--lc-bg-card);
            border: 1px solid var(--lc-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 0.8rem;
            color: var(--lc-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--lc-gold);
        }
        
        .pending-list {
            background: var(--lc-bg-card);
            border: 1px solid var(--lc-border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .pending-list-header {
            background: rgba(201, 169, 97, 0.1);
            padding: 16px 20px;
            border-bottom: 1px solid var(--lc-border);
        }
        
        .pending-list-header h2 {
            color: var(--lc-gold);
            font-size: 1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .record-item {
            padding: 20px;
            border-bottom: 1px solid var(--lc-border);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .record-id {
            font-size: 0.75rem;
            color: var(--lc-text-muted);
            font-family: 'Cinzel', monospace;
        }
        
        .record-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .record-info .username {
            font-weight: 600;
            color: var(--lc-text);
        }
        
        .record-info .details {
            font-size: 0.85rem;
            color: var(--lc-text-secondary);
        }
        
        .record-info .time {
            font-size: 0.8rem;
            color: var(--lc-gold);
            font-family: 'Cinzel', monospace;
        }
        
        .record-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-approve, .btn-reject {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-approve {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }
        
        .btn-approve:hover {
            background: rgba(34, 197, 94, 0.2);
        }
        
        .btn-reject {
            background: rgba(201, 79, 79, 0.1);
            border-color: rgba(201, 79, 79, 0.5);
            color: var(--lc-red);
        }
        
        .btn-reject:hover {
            background: rgba(201, 79, 79, 0.2);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--lc-text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--lc-gold);
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="logo-text">
                <h1>管理后台</h1>
                <span class="logo-subtitle">Limbus Company · 审核系统</span>
            </div>
        </div>
        <div class="nav-meta">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i> 返回主页
            </a>
            <button onclick="logout()" class="back-link" style="background: none; border: none; cursor: pointer; margin-left: 16px;">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-clipboard-check"></i> 排行榜审核管理</h1>
            <button onclick="loadPendingList()" class="control-btn">
                <i class="fas fa-sync"></i> 刷新列表
            </button>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <h3>待审核</h3>
                <div class="number" id="pending-count">-</div>
            </div>
            <div class="stat-card">
                <h3>已通过</h3>
                <div class="number" id="approved-count">-</div>
            </div>
            <div class="stat-card">
                <h3>已拒绝</h3>
                <div class="number" id="rejected-count">-</div>
            </div>
        </div>

        <div class="pending-list">
            <div class="pending-list-header">
                <h2><i class="fas fa-clock"></i> 待审核记录</h2>
            </div>
            <div id="pending-list-content">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                </div>
            </div>
        </div>
    </div>

    <script>
        // 检查登录状态
        (function checkLogin() {
            const loggedIn = sessionStorage.getItem('admin_logged_in');
            const loginTime = sessionStorage.getItem('admin_login_time');
            
            // 检查是否登录（登录有效期2小时）
            if (!loggedIn || !loginTime || Date.now() - parseInt(loginTime) > 2 * 60 * 60 * 1000) {
                sessionStorage.removeItem('admin_logged_in');
                sessionStorage.removeItem('admin_login_time');
                window.location.href = 'admin-login.html';
            }
        })();

        const API_BASE = '/api';

        async function loadPendingList() {
            const contentEl = document.getElementById('pending-list-content');
            contentEl.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';

            try {
                // 获取待审核列表
                const response = await fetch(`${API_BASE}/rankings/pending`);
                const result = await response.json();

                // 获取所有记录用于统计
                const allResponse = await fetch(`${API_BASE}/rankings/list?limit=1000`);
                const allResult = await allResponse.json();

                updateStats(result.data || [], allResult.data?.records || []);
                renderPendingList(result.data || []);
            } catch (error) {
                contentEl.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>加载失败: ${error.message}</p></div>`;
            }
        }

        function updateStats(pending, all) {
            document.getElementById('pending-count').textContent = pending.length;
            document.getElementById('approved-count').textContent = all.length;
            // 拒绝的数量需要从服务器获取，这里简化处理
            document.getElementById('rejected-count').textContent = '-';
        }

        function renderPendingList(records) {
            const contentEl = document.getElementById('pending-list-content');

            if (records.length === 0) {
                contentEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>暂无待审核记录</p>
                    </div>
                `;
                return;
            }

            contentEl.innerHTML = records.map(record => `
                <div class="record-item" data-id="${record.id}">
                    <div class="record-id">#${record.id}</div>
                    <div class="record-info">
                        <div class="username">${escapeHtml(record.username)}</div>
                        <div class="details">
                            ${escapeHtml(record.sinner)} · ${escapeHtml(record.persona)} · 第${record.floor_level}层
                        </div>
                        <div class="time">
                            <i class="fas fa-clock"></i> ${formatTime(record.time)} · 
                            <i class="fas fa-calendar"></i> ${new Date(record.created_at).toLocaleString('zh-CN')}
                        </div>
                    </div>
                    <div class="record-actions">
                        <button class="btn-approve" onclick="approveRecord(${record.id})">
                            <i class="fas fa-check"></i> 通过
                        </button>
                        <button class="btn-reject" onclick="rejectRecord(${record.id})">
                            <i class="fas fa-times"></i> 拒绝
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveRecord(id) {
            await reviewRecord(id, 'approve');
        }

        async function rejectRecord(id) {
            await reviewRecord(id, 'reject');
        }

        async function reviewRecord(id, action) {
            try {
                const response = await fetch(`${API_BASE}/rankings/approve/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                const result = await response.json();

                if (result.success) {
                    alert(action === 'approve' ? '审核通过！' : '已拒绝');
                    loadPendingList();
                } else {
                    alert('操作失败: ' + result.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 退出登录
        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            sessionStorage.removeItem('admin_login_time');
            window.location.href = 'admin-login.html';
        }

        // 页面加载时获取列表
        loadPendingList();
    </script>
</body>
</html>
